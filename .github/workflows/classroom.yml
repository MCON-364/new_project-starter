name: Classroom Autograding

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Detect project structure
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          if [ -f pom.xml ]; then
            echo "has_pom=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_pom=false" >> "$GITHUB_OUTPUT"
          fi

          if [ -d src/main/java ]; then
            echo "has_src=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_src=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Copy autograding tests into src/test/java
        if: steps.detect.outputs.has_pom == 'true'
        shell: bash
        run: |
          mkdir -p src/test/java
          cp -R .github/autograding_tests/* src/test/java/

      - name: Run unit tests
        id: unit
        if: steps.detect.outputs.has_pom == 'true'
        shell: bash
        env:
          USER_NAME: Alice
        run: |
          set +e
          mvn -B -ntp test
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Compute score
        id: score
        shell: bash
        run: |
          set -euo pipefail

          SCORE=0

          if [ "${{ steps.detect.outputs.has_pom }}" = "true" ]; then
            # Default for Maven project present but tests failing or not run.
            SCORE=80
            # If unit tests ran and succeeded, full credit.
            if [ "${{ steps.unit.outputs.exit_code || '1' }}" = "0" ]; then
              SCORE=100
            fi
          fi

          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "Final score: $SCORE"

      - name: Report grade to GitHub Classroom
        if: always()
        uses: classroom-resources/autograding-grading-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          test-name: maven-unit-tests
          points: ${{ steps.score.outputs.score }}
          max-points: 100
